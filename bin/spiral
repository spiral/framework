#!/usr/bin/env php
<?php

/**
 * Download spiral application server binary.
 */

declare(strict_types=1);

$autoload = [
    __DIR__ . '/../../../autoload.php',
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/vendor/autoload.php'
];

foreach ($autoload as $file) {
    if (is_file($file)) {
        define('RR_COMPOSER_INSTALL', $file);

        break;
    }
}

unset($file);

if (!defined('RR_COMPOSER_INSTALL')) {
    fwrite(
        STDERR,
        'You need to set up the project dependencies using Composer:' . PHP_EOL . PHP_EOL .
        '    composer install' . PHP_EOL . PHP_EOL .
        'You can learn all about Composer on https://getcomposer.org/.' . PHP_EOL
    );

    die(1);
}

if (RRHelper::getOSType() !== 'linux' && !class_exists('ZipArchive')) {
    fwrite(STDERR, 'Extension `php-zip` is required.' . PHP_EOL);
    die(1);
}

if (!function_exists('curl_init')) {
    fwrite(STDERR, 'Extension `php-curl` is required.' . PHP_EOL);
    die(1);
}

require RR_COMPOSER_INSTALL;

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Helper\ProgressBar;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Question\ConfirmationQuestion;

class RRHelper
{
    public function __construct()
    {
    }

    /**
     * Returns version of RoadRunner based on build.sh file
     *
     * @return string Version of RoadRunner
     * @throws Exception
     */
    public static function getVersion(): string
    {
        $file = __DIR__ . DIRECTORY_SEPARATOR . '..' . DIRECTORY_SEPARATOR . 'build.sh';
        $fileResource = fopen($file, 'rb') or die(1);

        while (!feof($fileResource)) {
            $line = fgets($fileResource, 4096);
            $matches = [];
            if (preg_match("/^SPIRAL_VERSION=(.*)/", $line, $matches)) {
                return trim($matches[1]);
            }
        }

        fclose($fileResource);
        throw new Exception("Can't find version of Spiral Server");
    }

    /**
     * Returns OS Type for filename
     *
     * @return string OS Type
     */
    public static function getOSType(): string
    {
        switch (PHP_OS) {
            case 'Darwin':
                return 'darwin';
            case 'Linux':
                return 'linux';
            case 'FreeBSD':
                return 'freebsd';
            case 'WIN32':
            case 'WINNT':
            case 'Windows':
                return 'windows';
            default:
                return 'linux';
        }
    }

    /**
     * @return string
     * @throws Exception
     */
    public static function getSignature(): string
    {
        return 'spiral-' . self::getVersion() . '-' . self::getOSType() . '-amd64';
    }

    /**
     * Returns generated URL to zip file on GitHub with binary file
     *
     * @return string URL
     * @throws Exception
     */
    public static function getBinaryDownloadUrl(): string
    {
        $ext = '.zip';
        if (self::getOSType() === 'linux') {
            $ext = '.tar.gz';
        }

        $version = static::getVersion();
        if (version_compare($version, '2.9.0', '<')) {
            $version = 'v'.$version;
        }

        return 'https://github.com/spiral/framework/releases/download/'
            . $version . '/' . self::getSignature()
            . $ext;
    }

    /**
     * Extracts the roadrunner RR binary into given location.
     *
     * @param string $archive
     * @param string $target
     * @throws Exception
     */
    public static function extractBinary(string $archive, string $target)
    {
        if (self::getOSType() !== 'linux') {
            self::extractZIP($archive, $target);
        } else {
            self::extractTAR($archive, $target);
        }
    }

    /**
     * @param string $archive
     * @param string $target
     * @throws Exception
     */
    protected static function extractZIP(string $archive, string $target)
    {
        $zip = new ZipArchive();
        $zip->open($archive);

        $name = self::getSignature() . '/spiral';
        if (self::getOSType() === 'windows') {
            $name .= '.exe';
        }

        $stream = $zip->getStream($name);
        if (!is_resource($stream)) {
            return;
        }

        $to = fopen($target, 'wb');
        stream_copy_to_stream($stream, $to);
        fclose($to);

        $zip->close();
    }

    /**
     * @param string $archive
     * @param string $target
     * @throws Exception
     */
    protected static function extractTAR(string $archive, string $target)
    {
        $arch = new PharData($archive);
        $arch->extractTo('./', self::getSignature() . '/spiral');

        copy('./' . self::getSignature() . '/spiral', $target);
        unlink('./' . self::getSignature() . '/spiral');
        rmdir('./' . self::getSignature());
    }
}

(new Application('Spiral Server', RRHelper::getVersion()))
    ->register('get-binary')
    ->setDescription("Install or update Spiral binaries in specified folder (current folder by default)")
    ->addOption('location', 'l', InputArgument::OPTIONAL, 'destination folder', '.')
    ->setCode(function (InputInterface $input, OutputInterface $output) {
        $output->writeln('<info>Updating binary file of Spiral Server</info>');

        $finalFile = $input->getOption('location') . DIRECTORY_SEPARATOR . 'spiral';
        if (RRHelper::getOSType() === 'windows') {
            $finalFile .= '.exe';
        }

        if (is_file($finalFile)) {
            $version = RRHelper::getVersion();

            $previousVersion = preg_match(
                '#Version:.+(\d+\.\d+\.\d+)#',
                (string)shell_exec($finalFile),
                $matches
            ) ? $matches[1] : "";

            $output->writeln('<error>RoadRunner binary file already exists!</error>');
            $helper = $this->getHelper('question');

            if (version_compare($previousVersion, $version) === 0) {
                $output->writeln(sprintf('<info>Current version: %s</info>', $previousVersion));
                $question = new ConfirmationQuestion(
                    sprintf('Skip update to the same version: %s ? [Y/n]', $version)
                );
                if ($helper->ask($input, $output, $question)) {
                    return;
                }
            } else {
                $question = new ConfirmationQuestion('Do you want overwrite it? [Y/n]');
                if (!$helper->ask($input, $output, $question)) {
                    return;
                }
            }
        }

        $output->writeln('<info>Downloading Spiral Server archive for <fg=cyan>' . ucfirst(RRHelper::getOSType()) . '</fg=cyan></info>');

        $progressBar = new ProgressBar($output);
        $progressBar->setFormat('verbose');

        $zipFileName = 'rr_zip_'.random_int(0, 10000);
        if (RRHelper::getOSType() === 'linux') {
            $zipFileName .= '.tar.gz';
        }

        $zipFile = fopen($zipFileName, 'wb+');
        $curlResource = curl_init();

        curl_setopt($curlResource, CURLOPT_URL, RRHelper::getBinaryDownloadUrl());
        curl_setopt($curlResource, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($curlResource, CURLOPT_BINARYTRANSFER, true);
        curl_setopt($curlResource, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($curlResource, CURLOPT_FOLLOWLOCATION, true);
        curl_setopt($curlResource, CURLOPT_FILE, $zipFile);
        curl_setopt($curlResource, CURLOPT_PROGRESSFUNCTION,
            function ($resource, $download_size, $downloaded, $upload_size, $uploaded) use ($progressBar) {
                if ($download_size === 0) {
                    return;
                }

                if ($progressBar->getStartTime() === 0) {
                    $progressBar->start();
                }

                $progressBar->setFormat('[%bar%] %percent:3s%% %elapsed:6s%/%estimated:-6s% ' . intval($download_size / 1024) . 'KB');
                $progressBar->setMaxSteps($download_size);
                $progressBar->setProgress($downloaded);
            });
        curl_setopt($curlResource, CURLOPT_NOPROGRESS, false); // needed to make progress function work
        curl_setopt($curlResource, CURLOPT_HEADER, 0);
        curl_exec($curlResource);
        curl_close($curlResource);
        fclose($zipFile);

        $progressBar->finish();
        $output->writeln("");

        $output->writeln('<info>Unpacking <comment>' . basename(RRHelper::getBinaryDownloadUrl()) . '</comment></info>');

        RRHelper::extractBinary($zipFileName, $finalFile);
        unlink($zipFileName);

        if (!file_exists($finalFile) || filesize($finalFile) === 0) {
            throw new Exception('Unable to extract the file.');
        }

        chmod($finalFile, 0755);
        $output->writeln('<info>Binary file updated!</info>');
    })
    ->getApplication()
    ->run();
